// Gordon Dry
// https://forum.kerbalspaceprogram.com/index.php?/topic/174912-cold-reentry-no-ablator-consumed/

@PART[*]:HAS[@MODULE[ModuleAblatorImproved]]:NEEDS[!DeadlyReentry,!RealismOverhaul,ImprovedAblator]:FINAL
{
	@MODULE[ModuleAblatorImproved]
	{
		@name = ModuleAblator
	}
}

@PART[*]:HAS[@MODULE[ModuleAblator]]:NEEDS[!DeadlyReentry,!RealismOverhaul]:FINAL
{
	%maxTemp=1400
	%skinMaxTemp=2500
	@MODULE[ModuleAblator]
	{
		@pyrolysisLossFactor = 1200
		@lossConst = 0.12
		@lossExp = -6000
		@ablationTempThresh = 1000 // was 500K (redunant to the change above)
		%useChar = True
		%charModuleName = shieldChar
	}
	@RESOURCE[Ablator]
	{
		// Default to lighter heat shields.
		@amount *= 0.5

		// Allow bigger heat shields. Useful for repeat flybys.
		@maxAmount *= 2
	}
}

@PART[*]:HAS[@MODULE[ModuleAblator]]:NEEDS[!DeadlyReentry,!RealismOverhaul,RealHeat]:FINAL
{
	%maxTemp=900
	%skinMaxTemp=1500
	@MODULE[ModuleAblator]
	{
//		@pyrolysisLossFactor *= 0.1
//		@lossConst *= 0.1
//		@lossExp *= 0.1
		@ablationTempThresh = 600
	}
}

@PART[InflatableHeatShield]:NEEDS[!DeadlyReentry,!RealismOverhaul]:FINAL
{
    @maxTemp = 1500
    @skinMaxTemp = 2500
}

@PART[InflatableHeatShield]:NEEDS[!DeadlyReentry,!RealismOverhaul,RealHeat]:FINAL
{
    @maxTemp = 1000
    @skinMaxTemp = 2000
}

@PART[InflatableHeatShield]:NEEDS[!DeadlyReentry,!RealismOverhaul]:FINAL
{
	@MODULE[ModuleAblator]
	{
		!useChar = delete
		!charModuleName = delete
	}
}

@PART[KADEPT*]:NEEDS[TokamakIndustries,!DeadlyReentry]:FINAL
{
    // Special treatment of the foldable KADEPT heatshields from TokamakIndustries
    // because they rock - and they're made of high-tech Mystery Goo impregnated fabric
    @maxTemp = 1600
    @skinMaxTemp = 3000
}

@PART[KADEPT*]:NEEDS[TokamakIndustries,!DeadlyReentry,!RealismOverhaul,RealHeat]:FINAL
{
    @maxTemp = 1100
    @skinMaxTemp = 2500
}

@PART[KADEPT*]:NEEDS[TokamakIndustries,!DeadlyReentry,!RealismOverhaul,ImprovedAblator]:FINAL
{
	@MODULE[ModuleAblator]
	{
		!useChar = delete
		!charModuleName = delete
	}
}

@PART[ServiceBay_*]:NEEDS[!RealismOverhaul,!RealHeat]:FINAL
{
    // Who needs a heat shield when a service bay is totally indestructible?
    // stock max temp was 3000.
    @maxTemp = 1600
}

@PART[ServiceBay_*]:NEEDS[!RealismOverhaul,RealHeat]:FINAL
{
    @maxTemp = 1100
}

@PART[*]:HAS[@MODULE[ModuleCommand],!MODULE[KerbalEVA],!MODULE[ModuleAblator],#CrewCapacity[>0]]:NEEDS[!DeadlyReentry,!RealismOverhaul]:FINAL
{
	// This is a crewed pod - is it supposed to be hotter than a hardcore finnish sauna inside?
	// Caution!
	%maxTemp=500
	%skinMaxTemp=1200

	// Add the option of some minimal built-in heat shielding. This makes it
	// playable in lower tech games, otherwise death is instantaneous and
	// certain. It also helps protect it against grazing heating.
	// MODULE
	// {
		// name = ModuleAblator
		// ablativeResource = Ablator
		// lossExp = -2500
		// lossConst = 0.002
		// pyrolysisLossFactor = 5400
		// reentryConductivity = 0.01
		// ablationTempThresh = 500
		
		// useChar = True
		// charModuleName = shieldChar
	// }

	// RESOURCE
	// {
		// name = Ablator
		// amount = 10
		// maxAmount = 20
	// }	
	// // and adjust the mass so we don't get the ablator mass as a weight
	// // discount.
	// @mass -= 0.01
}

@PART[*]:HAS[@MODULE[ModuleCommand],!MODULE[KerbalEVA],@MODULE[ModuleAblator],#CrewCapacity[>0]]:NEEDS[!DeadlyReentry,!RealismOverhaul,RealHeat]:FINAL
{
	%maxTemp=400
	%skinMaxTemp=1000
	// @MODULE[ModuleAblator]
	// {
		// @pyrolysisLossFactor *= 0.1
		// @lossConst *= 0.1
		// @ablationTempThresh = 400
	// }
}

// is this even useful anymore?
@PART[*]:HAS[@MODULE[ModuleAblator],@MODULE[ModuleLiftingSurface]]:NEEDS[FerramAerospaceResearch]:FINAL
{
	!MODULE[ModuleLiftingSurface] { }
}

// @PART[*]:HAS[@MODULE[ModuleAblator],@MODULE[ModuleAnimateHeat]]:NEEDS[!DeadlyReentry,!RealismOverhaul]:FINAL
// {
	// @MODULE[ModuleAnimateHeat]
	// {
// //		%ThermalAnim = overheat
		// %ThermalAnim = hsanim
		// %useTemp = false
		// %useSkinTemp = true
	// }
// }

// @PART[*]:HAS[@MODULE[ModuleAblator],!MODULE[ModuleColorChanger]]:NEEDS[!DeadlyReentry,!RealismOverhaul]:FOR[zzz_HeatShieldsFix7]
// {
	// MODULE
	// {
		// name = ModuleColorChanger
		// moduleID = shieldChar
		// shaderProperty = _BurnColor
		// useRate = False
		// toggleInEditor = False
		// toggleInFlight = False
		
		// redCurve
		// {
			// key = 0 0
			// key = 1 1
		// }
		// greenCurve
		// {
			// key = 0 0
			// key = 1 1
		// }
		// blueCurve
		// {
			// key = 0 0
			// key = 1 1
		// }
		// alphaCurve
		// {
			// key = 0 0.8
		// }
	// }
// }	

// @PART[*]:HAS[@MODULE[ModuleAblator]]:NEEDS[!DeadlyReentry,!RealismOverhaul]:FINAL // ,!FerramAerospaceResearch
// {
	// @thermalMassModifier *= 0.5
// }

// @PHYSICSGLOBALS:NEEDS[!FerramAerospaceResearch]:FINAL
// {
	// @convectionVelocityExponent = 3.35
// }

// @RESOURCE_DEFINITION[Ablator]:NEEDS[!FerramAerospaceResearch]:FINAL
// {
	// @hsp = 1000 // KSP 1.4.x stock value is 400, it was 100 way earlier
// }

@PART[*]:HAS[@MODULE[ModuleAblator]]:NEEDS[!DeadlyReentry,!RealismOverhaul,ImprovedAblator]:FINAL
{
	@MODULE[ModuleAblator]
	{
		@name = ModuleAblatorImproved
	}
}

// I could try to alter it that the values differ, for example by taking mass into account and using  "low pass filters" and "high pass filters" to have set minimum and maximum values.